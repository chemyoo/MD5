<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>MD5在线计算</title>
		<style>
			/**  IE、火狐初始化背景色*/
			.progressbar {
				color: green;
				border: 0px;
				background-color: powderblue;
			}
			
			progress {
				-webkit-appearance: none;
			}
			
			progress::-webkit-progress-inner-element {
				background-color: powderblue;
			}
			
			/**  火狐表示已完成背景色*/
			progress::-moz-progress-bar {
				background-color: green;
			}
			
			/** Chrome初始化背景色*/
			progress::-webkit-progress-bar {
				background-color: powderblue;
			}
			
			/** Chrome表示已完成背景色*/
			progress::-webkit-progress-value {
				background-color: green;
			}
			
			progress::-ms-fill {
				background-color: powderblue;
			}
		</style>

	</head>

	<body>
		<div style="text-align: center;margin:0 auto;width: 550px;">
			<form style="text-align: left;" id="fileupload" action="" method="POST" enctype="multipart/form-data">
				<div>
					<div>
						添加文件计算MD5值：
						<input type="file" name="file" id="fileinput">
					</div>

					<progress class='progressbar' value="0" max="100" style='width:500px;margin-top:20px'></progress>
					<span id="percent" style="color: green;"></span>
					<div style='margin-top:20px'>
						<span id="handler_info"></span>
					</div>
				</div>
			</form>
		</div>
		<script src="spark-md5.js" type="text/javascript"></script>
		<!--<script src="https://raw.githack.com/satazor/js-spark-md5/master/spark-md5.js" type="text/javascript"></script>-->
		<script>
			var progressbar = document.getElementsByClassName("progressbar")[0];
			var uploadfile = document.getElementById('fileinput')
			var percent = document.getElementById("percent");

			function get_filemd5sum(ofile) {
				var file = ofile;
				var tmp_md5;
				var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
					// file = this.files[0],
					chunkSize = 8097152, // Read in chunks of 2MB
					chunks = Math.ceil(file.size / chunkSize),
					currentChunk = 0,
					spark = new SparkMD5.ArrayBuffer(),
					fileReader = new FileReader(),
					md5_progress = 0;

					fileReader.onload = function(e) {
					// console.log('read chunk nr', currentChunk + 1, 'of', chunks);
					spark.append(e.target.result); // Append array buffer
					currentChunk++;
					if(chunks == 0) {
						chunks = currentChunk;
					}
					md5_progress = Math.floor((currentChunk / chunks) * 100);

					percent.innerText = md5_progress + "%";
					console.log(file.name + "  正在处理，请稍等," + "已完成" + md5_progress + "%");
					var handler_info = document.getElementById("handler_info");
					handler_info.innerHTML = file.name + "  正在处理，请稍等," + "已完成" + md5_progress + "%"
					progressbar.value = md5_progress;
					if(currentChunk < chunks) {
						loadNext();
					} else {
						tmp_md5 = spark.end();
						console.log(tmp_md5)
						handler_info.innerHTML = file.name + "的MD5值是：" + tmp_md5;
					}
				};

				fileReader.onerror = function() {
					console.warn('oops, something went wrong.');
				};

				function loadNext() {
					var start = currentChunk * chunkSize,
						end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;
					fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
				}
				loadNext();
			}

			uploadfile.onchange = function(e) {
				reset();
				var file = this.files[0];
				if(!file) {
					alert('请选择文件！');
					return false;
				}
				get_filemd5sum(file)
			}
			
			/**
			 * 重置显示值
			 */
			var reset = function() {
				progressbar.value = 0;
				percent.innerText = "0%";
			}
		</script>
	</body>

</html>